(self.webpackChunk_modern_js_main_doc=self.webpackChunk_modern_js_main_doc||[]).push([["docs_zh_configure_app_output_assets-retry_mdx"],{1873:function(e,s,n){"use strict";n.r(s),n.d(s,{default:function(){return l}});var r,t=n("15169"),i=n("43932"),d=n("9880"),c=n("23169");function a(e){var s=Object.assign({ul:"ul",li:"li",strong:"strong",code:"code",p:"p",pre:"pre",h3:"h3",a:"a"},(0,c.useMDXComponents)(),e.components);return(0,d.jsxs)(d.Fragment,{children:[(0,d.jsxs)(s.ul,{children:["\n",(0,d.jsxs)(s.li,{children:[(0,d.jsx)(s.strong,{children:"类型："})," ",(0,d.jsx)(s.code,{children:"Object"})]}),"\n"]}),"\n",(0,d.jsxs)(s.p,{children:[(0,d.jsx)(s.code,{children:"output.assetsRetry"})," 用于配置资源加载失败时的重试逻辑。配置类型如下:"]}),"\n",(0,d.jsx)(s.pre,{children:(0,d.jsx)(s.code,{className:"language-ts",children:"export type AssetsRetryHookContext = {\n  times: number;\n  domain: string;\n  url: string;\n  tagName: string;\n};\n\nexport type AssetsRetryOptions = {\n  type?: string[];\n  domain?: string[];\n  max?: number;\n  test?: string | ((url: string) => boolean);\n  crossOrigin?: boolean | 'anonymous' | 'use-credentials';\n  inlineScript?: boolean;\n  onRetry?: (options: AssetsRetryHookContext) => void;\n  onSuccess?: (options: AssetsRetryHookContext) => void;\n  onFail?: (options: AssetsRetryHookContext) => void;\n};\n"})}),"\n",(0,d.jsx)(s.p,{children:"由于该能力会往 HTML 中注入额外的一些运行时代码，因此我们默认关闭了该能力，如果需要开启该能力，你可以添加以下配置："}),"\n",(0,d.jsx)(s.pre,{children:(0,d.jsx)(s.code,{className:"language-js",children:"export default {\n  output: {\n    assetsRetry: {},\n  },\n};\n"})}),"\n",(0,d.jsxs)(s.p,{children:["当你开启该能力后，",(0,d.jsx)(s.code,{children:"assetsRetry"})," 的默认配置如下："]}),"\n",(0,d.jsx)(s.pre,{children:(0,d.jsx)(s.code,{className:"language-ts",children:"export const defaultAssetsRetryOptions: AssetsRetryOptions = {\n  type: ['script', 'link', 'img'],\n  domain: [],\n  max: 3,\n  test: '',\n  crossOrigin: false,\n  onRetry: () => {},\n  onSuccess: () => {},\n  onFail: () => {},\n};\n"})}),"\n",(0,d.jsx)(s.p,{children:"同时你也可以使用以下的配置项，来定制你的重试逻辑。"}),"\n",(0,d.jsxs)(s.h3,{id:"assetsretrydomain",children:["assetsRetry.domain",(0,d.jsx)(s.a,{className:"header-anchor","aria-hidden":"true",href:"#assetsretrydomain",children:"#"})]}),"\n",(0,d.jsxs)(s.ul,{children:["\n",(0,d.jsxs)(s.li,{children:[(0,d.jsx)(s.strong,{children:"类型："})," ",(0,d.jsx)(s.code,{children:"string[]"})]}),"\n",(0,d.jsxs)(s.li,{children:[(0,d.jsx)(s.strong,{children:"默认值："})," ",(0,d.jsx)(s.code,{children:"[]"})]}),"\n"]}),"\n",(0,d.jsxs)(s.p,{children:["指定资源加载失败时的重试域名列表。在 ",(0,d.jsx)(s.code,{children:"domain"})," 数组中，第一项是当前使用的域名，后面几项为备用域名。当某个域名的资源请求失败时，Builder 会在数组中找到该域名，并替换为数组的下一个域名。"]}),"\n",(0,d.jsx)(s.p,{children:"比如："}),"\n",(0,d.jsx)(s.pre,{children:(0,d.jsx)(s.code,{className:"language-js",children:"export default {\n  output: {\n    assetsRetry: {\n      domain: ['https://cdn1.com', 'https://cdn2.com', 'https://cdn3.com'],\n    },\n  },\n};\n"})}),"\n",(0,d.jsxs)(s.p,{children:["添加以上配置后，当 ",(0,d.jsx)(s.code,{children:"cdn1.com"})," 域名的资源加载失败时，请求域名会自动降级到 ",(0,d.jsx)(s.code,{children:"cdn2.com"}),"。"]}),"\n",(0,d.jsxs)(s.p,{children:["如果 ",(0,d.jsx)(s.code,{children:"cdn2.com"})," 的资源也请求失败，则会继续请求 ",(0,d.jsx)(s.code,{children:"cdn3.com"}),"。"]}),"\n",(0,d.jsxs)(s.h3,{id:"assetsretrytype",children:["assetsRetry.type",(0,d.jsx)(s.a,{className:"header-anchor","aria-hidden":"true",href:"#assetsretrytype",children:"#"})]}),"\n",(0,d.jsxs)(s.ul,{children:["\n",(0,d.jsxs)(s.li,{children:[(0,d.jsx)(s.strong,{children:"类型："})," ",(0,d.jsx)(s.code,{children:"string[]"})]}),"\n",(0,d.jsxs)(s.li,{children:[(0,d.jsx)(s.strong,{children:"默认值："})," ",(0,d.jsx)(s.code,{children:"['script', 'link', 'img']"})]}),"\n"]}),"\n",(0,d.jsx)(s.p,{children:"用于指定需要进行重试的 HTML 标签类型。默认会处理 script 标签、link 标签和 img 标签，对应 JS 代码、CSS 代码和图片。"}),"\n",(0,d.jsx)(s.p,{children:"比如只对 script 标签和 link 标签进行处理："}),"\n",(0,d.jsx)(s.pre,{children:(0,d.jsx)(s.code,{className:"language-js",children:"export default {\n  output: {\n    assetsRetry: {\n      type: ['script', 'link'],\n    },\n  },\n};\n"})}),"\n",(0,d.jsxs)(s.h3,{id:"assetsretrymax",children:["assetsRetry.max",(0,d.jsx)(s.a,{className:"header-anchor","aria-hidden":"true",href:"#assetsretrymax",children:"#"})]}),"\n",(0,d.jsxs)(s.ul,{children:["\n",(0,d.jsxs)(s.li,{children:[(0,d.jsx)(s.strong,{children:"类型："})," ",(0,d.jsx)(s.code,{children:"number"})]}),"\n",(0,d.jsxs)(s.li,{children:[(0,d.jsx)(s.strong,{children:"默认值："})," ",(0,d.jsx)(s.code,{children:"3"})]}),"\n"]}),"\n",(0,d.jsx)(s.p,{children:"单个资源的最大重试次数。比如："}),"\n",(0,d.jsx)(s.pre,{children:(0,d.jsx)(s.code,{className:"language-js",children:"export default {\n  output: {\n    assetsRetry: {\n      max: 5,\n    },\n  },\n};\n"})}),"\n",(0,d.jsxs)(s.h3,{id:"assetsretrytest",children:["assetsRetry.test",(0,d.jsx)(s.a,{className:"header-anchor","aria-hidden":"true",href:"#assetsretrytest",children:"#"})]}),"\n",(0,d.jsxs)(s.ul,{children:["\n",(0,d.jsxs)(s.li,{children:[(0,d.jsx)(s.strong,{children:"类型："})," ",(0,d.jsx)(s.code,{children:"string | ((url: string) => boolean) | undefined"})]}),"\n",(0,d.jsxs)(s.li,{children:[(0,d.jsx)(s.strong,{children:"默认值："})," ",(0,d.jsx)(s.code,{children:"undefined"})]}),"\n"]}),"\n",(0,d.jsx)(s.p,{children:"匹配资源 URL 的正则表达式或函数，默认匹配所有资源。比如："}),"\n",(0,d.jsx)(s.pre,{children:(0,d.jsx)(s.code,{className:"language-js",children:"export default {\n  output: {\n    assetsRetry: {\n      test: /cdn\\.example\\.com/,\n    },\n  },\n};\n"})}),"\n",(0,d.jsxs)(s.h3,{id:"assetsretrycrossorigin",children:["assetsRetry.crossOrigin",(0,d.jsx)(s.a,{className:"header-anchor","aria-hidden":"true",href:"#assetsretrycrossorigin",children:"#"})]}),"\n",(0,d.jsxs)(s.ul,{children:["\n",(0,d.jsxs)(s.li,{children:[(0,d.jsx)(s.strong,{children:"类型："})," ",(0,d.jsx)(s.code,{children:"undefined | boolean | 'anonymous' | 'use-credentials'"})]}),"\n",(0,d.jsxs)(s.li,{children:[(0,d.jsx)(s.strong,{children:"默认值："})," ",(0,d.jsx)(s.code,{children:"与 html.crossorigin 一致"})]}),"\n"]}),"\n",(0,d.jsxs)(s.p,{children:["在发起资源重新请求时，Builder 会重新创建 ",(0,d.jsx)(s.code,{children:"<script>"})," 标签，此选项可以设置这些标签的 ",(0,d.jsx)(s.code,{children:"crossorigin"})," 属性。"]}),"\n",(0,d.jsxs)(s.p,{children:["默认情况下，",(0,d.jsx)(s.code,{children:"assetsRetry.crossOrigin"})," 的值会与 ",(0,d.jsx)(s.code,{children:"html.crossorigin"})," 配置项保持一致，无须额外配置。如果你需要对重新创建的标签进行单独配置，可以使用该选项，比如："]}),"\n",(0,d.jsx)(s.pre,{children:(0,d.jsx)(s.code,{className:"language-js",children:"export default {\n  output: {\n    assetsRetry: {\n      crossOrigin: true,\n    },\n  },\n};\n"})}),"\n",(0,d.jsxs)(s.h3,{id:"assetsretryonretry",children:["assetsRetry.onRetry",(0,d.jsx)(s.a,{className:"header-anchor","aria-hidden":"true",href:"#assetsretryonretry",children:"#"})]}),"\n",(0,d.jsxs)(s.ul,{children:["\n",(0,d.jsxs)(s.li,{children:[(0,d.jsx)(s.strong,{children:"类型："})," ",(0,d.jsx)(s.code,{children:"undefined | (options: AssetsRetryHookContext) => void"})]}),"\n"]}),"\n",(0,d.jsx)(s.p,{children:"资源重试时的回调函数。比如："}),"\n",(0,d.jsx)(s.pre,{children:(0,d.jsx)(s.code,{className:"language-js",children:"export default {\n  output: {\n    assetsRetry: {\n      onRetry: ({ times, domain, url, tagName }) => {\n        console.log(\n          `Retry ${times} times, domain: ${domain}, url: ${url}, tagName: ${tagName}`,\n        );\n      },\n    },\n  },\n};\n"})}),"\n",(0,d.jsxs)(s.h3,{id:"assetsretryonsuccess",children:["assetsRetry.onSuccess",(0,d.jsx)(s.a,{className:"header-anchor","aria-hidden":"true",href:"#assetsretryonsuccess",children:"#"})]}),"\n",(0,d.jsxs)(s.ul,{children:["\n",(0,d.jsxs)(s.li,{children:[(0,d.jsx)(s.strong,{children:"类型："})," ",(0,d.jsx)(s.code,{children:"undefined | (options: AssetsRetryHookContext) => void"})]}),"\n"]}),"\n",(0,d.jsx)(s.p,{children:"资源重试成功时的回调函数。比如："}),"\n",(0,d.jsx)(s.pre,{children:(0,d.jsx)(s.code,{className:"language-js",children:"export default {\n  output: {\n    assetsRetry: {\n      onSuccess: ({ times, domain, url, tagName }) => {\n        console.log(\n          `Retry ${times} times, domain: ${domain}, url: ${url}, tagName: ${tagName}`,\n        );\n      },\n    },\n  },\n};\n"})}),"\n",(0,d.jsxs)(s.h3,{id:"assetsretryonfail",children:["assetsRetry.onFail",(0,d.jsx)(s.a,{className:"header-anchor","aria-hidden":"true",href:"#assetsretryonfail",children:"#"})]}),"\n",(0,d.jsxs)(s.ul,{children:["\n",(0,d.jsxs)(s.li,{children:[(0,d.jsx)(s.strong,{children:"类型："})," ",(0,d.jsx)(s.code,{children:"undefined | (options: AssetsRetryHookContext) => void"})]}),"\n"]}),"\n",(0,d.jsx)(s.p,{children:"资源重试超过最大重试次数时的回调函数。比如："}),"\n",(0,d.jsx)(s.pre,{children:(0,d.jsx)(s.code,{className:"language-js",children:"export default {\n  output: {\n    assetsRetry: {\n      onFail: ({ times, domain, url, tagName }) => {\n        console.log(\n          `Retry ${times} times, domain: ${domain}, url: ${url}, tagName: ${tagName}`,\n        );\n      },\n    },\n  },\n};\n"})}),"\n",(0,d.jsxs)(s.h3,{id:"assetsretryinlinescript",children:["assetsRetry.inlineScript",(0,d.jsx)(s.a,{className:"header-anchor","aria-hidden":"true",href:"#assetsretryinlinescript",children:"#"})]}),"\n",(0,d.jsxs)(s.ul,{children:["\n",(0,d.jsxs)(s.li,{children:[(0,d.jsx)(s.strong,{children:"类型："})," ",(0,d.jsx)(s.code,{children:"boolean"})]}),"\n",(0,d.jsxs)(s.li,{children:[(0,d.jsx)(s.strong,{children:"默认值："})," ",(0,d.jsx)(s.code,{children:"true"})]}),"\n"]}),"\n",(0,d.jsxs)(s.p,{children:["是否将 ",(0,d.jsx)(s.code,{children:"assetsRetry"})," 的运行时 JavaScript 代码内联到 HTML 文件中。"]}),"\n",(0,d.jsxs)(s.p,{children:["如果你不希望在 HTML 文件中插入相关代码，可以将 ",(0,d.jsx)(s.code,{children:"assetsRetry.inlineScript"})," 设置为 ",(0,d.jsx)(s.code,{children:"false"}),"："]}),"\n",(0,d.jsx)(s.pre,{children:(0,d.jsx)(s.code,{className:"language-js",children:"export default {\n  output: {\n    assetsRetry: {\n      inlineScript: false,\n    },\n  },\n};\n"})}),"\n",(0,d.jsxs)(s.p,{children:["添加以上配置后，",(0,d.jsx)(s.code,{children:"assetsRetry"})," 的运行时代码会被抽取为一个独立的 ",(0,d.jsx)(s.code,{children:"assets-retry.[version].js"})," 文件，并输出到产物目录下。"]}),"\n",(0,d.jsxs)(s.p,{children:["这种方式的弊端在于，",(0,d.jsx)(s.code,{children:"assets-retry.[version].js"})," 自身有加载失败的可能性。如果出现这种情况，静态资源重试的逻辑就无法生效。因此，我们更推荐将运行时代码内联到 HTML 文件中。"]}),"\n",(0,d.jsxs)(s.h3,{id:"注意事项",children:["注意事项",(0,d.jsx)(s.a,{className:"header-anchor","aria-hidden":"true",href:"#注意事项",children:"#"})]}),"\n",(0,d.jsxs)(s.p,{children:["当你使用 ",(0,d.jsx)(s.code,{children:"assetsRetry"})," 时，Builder 会向 HTML 中注入一段运行时代码，并将 ",(0,d.jsx)(s.code,{children:"assetsRetry"})," 配置的内容序列化，插入到这段代码中，因此你需要注意："]}),"\n",(0,d.jsxs)(s.ul,{children:["\n",(0,d.jsxs)(s.li,{children:["避免在 ",(0,d.jsx)(s.code,{children:"assetsRetry"})," 中配置敏感信息，比如内部使用的 token。"]}),"\n",(0,d.jsxs)(s.li,{children:["避免在 ",(0,d.jsx)(s.code,{children:"onRetry"}),"，",(0,d.jsx)(s.code,{children:"onSuccess"}),"，",(0,d.jsx)(s.code,{children:"onFail"})," 中引用函数外部的变量或方法。"]}),"\n",(0,d.jsxs)(s.li,{children:["避免在 ",(0,d.jsx)(s.code,{children:"onRetry"}),"，",(0,d.jsx)(s.code,{children:"onSuccess"}),"，",(0,d.jsx)(s.code,{children:"onFail"})," 中使用有兼容性问题的语法，因为这些函数会被直接内联到 HTML 中。"]}),"\n"]}),"\n",(0,d.jsx)(s.p,{children:"以下是一个错误示例："}),"\n",(0,d.jsx)(s.pre,{children:(0,d.jsx)(s.code,{className:"language-js",children:"import { someMethod } from 'utils';\n\nexport default {\n  output: {\n    assetsRetry: {\n      onRetry() {\n        // 错误用法，包含了敏感信息\n        const privateToken = 'a-private-token';\n\n        // 错误用法，使用了外部的方法\n        someMethod(privateToken);\n      },\n    },\n  },\n};\n"})}),"\n",(0,d.jsxs)(s.p,{children:["此外，如果你的工程是微前端应用（比如 Garfish 子应用），那么 ",(0,d.jsx)(s.code,{children:"assetsRetry"})," 可能无法生效，因为微前端子应用通常不是基于 ",(0,d.jsx)(s.code,{children:"<script>"})," 标签直接加载的。"]}),"\n",(0,d.jsx)(s.p,{children:"如果你需要对微前端场景的资源加载进行重试，请联系微前端框架的开发者，以寻找相应的解决方案。"})]})}(r=globalThis).__RSPRESS_PAGE_META||(r.__RSPRESS_PAGE_META={}),globalThis.__RSPRESS_PAGE_META["..%2F..%2Fbuilder-doc%2Fdocs%2Fzh%2Fconfig%2Foutput%2FassetsRetry.md"]={toc:[{text:"assetsRetry.domain",id:"assetsretrydomain",depth:3},{text:"assetsRetry.type",id:"assetsretrytype",depth:3},{text:"assetsRetry.max",id:"assetsretrymax",depth:3},{text:"assetsRetry.test",id:"assetsretrytest",depth:3},{text:"assetsRetry.crossOrigin",id:"assetsretrycrossorigin",depth:3},{text:"assetsRetry.onRetry",id:"assetsretryonretry",depth:3},{text:"assetsRetry.onSuccess",id:"assetsretryonsuccess",depth:3},{text:"assetsRetry.onFail",id:"assetsretryonfail",depth:3},{text:"assetsRetry.inlineScript",id:"assetsretryinlinescript",depth:3},{text:"注意事项",id:"注意事项",depth:3}],title:"",frontmatter:{}};var l=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},s=Object.assign({},(0,c.useMDXComponents)(),e.components).wrapper;return s?(0,d.jsx)(s,(0,i._)((0,t._)({},e),{children:(0,d.jsx)(a,(0,t._)({},e))})):a(e)}},58076:function(e,s,n){"use strict";n.r(s),n.d(s,{default:function(){return o}});var r,t=n("15169"),i=n("43932"),d=n("9880"),c=n("23169"),a=n("1873");function l(e){var s=Object.assign({h1:"h1",a:"a",div:"div",p:"p"},(0,c.useMDXComponents)(),e.components);return(0,d.jsxs)(d.Fragment,{children:[(0,d.jsxs)(s.h1,{id:"outputassetsretry",children:["output.assetsRetry",(0,d.jsx)(s.a,{className:"header-anchor","aria-hidden":"true",href:"#outputassetsretry",children:"#"})]}),"\n",(0,d.jsxs)(s.div,{className:"modern-directive tip",children:[(0,d.jsx)(s.div,{className:"modern-directive-title",children:"TIP"}),(0,d.jsx)(s.div,{className:"modern-directive-content",children:(0,d.jsxs)(s.p,{children:["该配置由 Modern.js Builder 提供，更多信息可参考 ",(0,d.jsx)(s.a,{href:"https://modernjs.dev/builder/api/config-output.html#outputassetsretry",target:"_blank",rel:"noopener noreferrer",children:"output.assetsRetry"}),"。\n"]})})]}),"\n","\n",(0,d.jsx)(a.default,{})]})}(r=globalThis).__RSPRESS_PAGE_META||(r.__RSPRESS_PAGE_META={}),globalThis.__RSPRESS_PAGE_META["zh%2Fconfigure%2Fapp%2Foutput%2Fassets-retry.mdx"]={toc:[],title:"output.assetsRetry",frontmatter:{sidebar_label:"assetsRetry"}};var o=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},s=Object.assign({},(0,c.useMDXComponents)(),e.components).wrapper;return s?(0,d.jsx)(s,(0,i._)((0,t._)({},e),{children:(0,d.jsx)(l,(0,t._)({},e))})):l(e)}}}]);