(self.webpackChunk_modern_js_module_tools_docs=self.webpackChunk_modern_js_module_tools_docs||[]).push([["docs_en_guide_advance_in-depth-about-build_md"],{90415:function(e,n,i){"use strict";i.r(n),i.d(n,{default:function(){return c}});var s,d=i("15169"),r=i("43932"),o=i("9880"),l=i("23169");function t(e){var n=Object.assign({h1:"h1",a:"a",p:"p",code:"code",div:"div",h2:"h2",h3:"h3",strong:"strong",ul:"ul",li:"li",h4:"h4",pre:"pre",blockquote:"blockquote"},(0,l.useMDXComponents)(),e.components);return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)(n.h1,{id:"in-depth-understanding-of-build",children:["In-depth understanding of build",(0,o.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#in-depth-understanding-of-build",children:"#"})]}),"\n",(0,o.jsxs)(n.p,{children:['In the "Basic Usage" section, we already knew that you can modify the output files of a project through the ',(0,o.jsx)(n.code,{children:"buildConfig"})," configuration. ",(0,o.jsx)(n.code,{children:"buildConfig"})," not only describes some of the features of the product, but also provides some functionality for building the product."]}),"\n",(0,o.jsxs)(n.div,{className:"modern-directive tip",children:[(0,o.jsx)(n.div,{className:"modern-directive-title",children:"TIP"}),(0,o.jsx)(n.div,{className:"modern-directive-content",children:(0,o.jsxs)(n.p,{children:["If you are not familiar with ",(0,o.jsx)(n.code,{children:"buildConfig"}),", please read ",(0,o.jsx)(n.a,{href:"/en/guide/basic/modify-output-product",children:"modify-output-product"}),".\n"]})})]}),"\n",(0,o.jsxs)(n.p,{children:["In this chapter we'll dive into the use of certain build configurations and understand what happens when the ",(0,o.jsx)(n.code,{children:"modern build"})," command is executed."]}),"\n",(0,o.jsxs)(n.h2,{id:"buildconfig",children:["buildConfig",(0,o.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#buildconfig",children:"#"})]}),"\n",(0,o.jsxs)(n.h3,{id:"bundle--bundleless",children:[(0,o.jsx)(n.code,{children:"bundle"})," / ",(0,o.jsx)(n.code,{children:"bundleless"}),(0,o.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#bundle--bundleless",children:"#"})]}),"\n",(0,o.jsx)(n.p,{children:"So first let's understand bundle and bundleless."}),"\n",(0,o.jsxs)(n.p,{children:["A bundle is a package of build products, which may be a single file or multiple files based on a certain ",(0,o.jsx)(n.a,{href:"https://esbuild.github.io/api/#splitting",target:"_blank",rel:"noopener noreferrer",children:"code splitting strategy"}),"."]}),"\n",(0,o.jsxs)(n.p,{children:["bundleless, on the other hand, means that each source file is compiled and built separately, but not bundled together. Each output file can be found with its corresponding source code file. The process of ",(0,o.jsx)(n.strong,{children:"bundleless build can also be understood as the process of code conversion of source files only"}),"."]}),"\n",(0,o.jsx)(n.p,{children:"They have their own benefits."}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"bundle can reduce the size of build artifacts and also pre-package dependencies to reduce the size of installed dependencies. Packaging libraries in advance can speed up application project builds."}),"\n",(0,o.jsx)(n.li,{children:"bundleless maintains the original file structure and is more conducive to debugging and tree shaking."}),"\n"]}),"\n",(0,o.jsxs)(n.div,{className:"modern-directive warning",children:[(0,o.jsx)(n.div,{className:"modern-directive-title",children:"WARNING"}),(0,o.jsx)(n.div,{className:"modern-directive-content",children:(0,o.jsxs)(n.p,{children:["bundleless is a single file compilation mode, so for type references and exports you need to add the ",(0,o.jsx)(n.code,{children:"type"})," field, e.g. ",(0,o.jsx)(n.code,{children:"import type { A } from '. /types"}),"\n"]})})]}),"\n",(0,o.jsxs)(n.p,{children:["In ",(0,o.jsx)(n.code,{children:"buildConfig"})," you can specify whether the current build task is bundle or bundleless by using ",(0,o.jsx)(n.a,{href:"/en/api/config/build-config#buildtype",children:(0,o.jsx)(n.code,{children:"buildConfig.buildType"})}),"."]}),"\n",(0,o.jsxs)(n.h3,{id:"input--sourcedir",children:[(0,o.jsx)(n.code,{children:"input"})," / ",(0,o.jsx)(n.code,{children:"sourceDir"}),(0,o.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#input--sourcedir",children:"#"})]}),"\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.a,{href:"/en/api/config/build-config#input",children:(0,o.jsx)(n.code,{children:"buildConfig.input"})})," is used to specify the file path or directory path where the source code is read, and its default value differs between bundle and bundleless builds."]}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["When ",(0,o.jsx)(n.code,{children:"buildType: 'bundle'"}),", ",(0,o.jsx)(n.code,{children:"input"})," defaults to ",(0,o.jsx)(n.code,{children:"src/index.(j|t)sx?"})]}),"\n",(0,o.jsxs)(n.li,{children:["When ",(0,o.jsx)(n.code,{children:"buildType: 'bundleless'"}),", ",(0,o.jsx)(n.code,{children:"input"})," defaults to ",(0,o.jsx)(n.code,{children:"['src']"})]}),"\n"]}),"\n",(0,o.jsxs)(n.div,{className:"modern-directive warning",children:[(0,o.jsx)(n.div,{className:"modern-directive-title",children:"WARNING"}),(0,o.jsx)(n.div,{className:"modern-directive-content",children:(0,o.jsx)(n.p,{children:"It is recommended that you do not specify multiple source file directories during a bundleless build, as unintended results may occur. bundleless builds with multiple source directories are currently in an unstable stage."})})]}),"\n",(0,o.jsxs)(n.p,{children:["We know from the defaults: ",(0,o.jsx)(n.strong,{children:"bundle builds can generally specify a file path as the entry point to the build, while bundleless builds are more expected to use directory paths to find source files"}),"."]}),"\n",(0,o.jsxs)(n.h4,{id:"object-type-of-input",children:["Object type of ",(0,o.jsx)(n.code,{children:"input"}),(0,o.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#object-type-of-input",children:"#"})]}),"\n",(0,o.jsxs)(n.p,{children:["In addition to setting ",(0,o.jsx)(n.code,{children:"input"})," to an array, you can also set it to an object during the bundle build process. ",(0,o.jsx)(n.strong,{children:"By using the object form, we can modify the name of the file that the build artifacts outputs"}),". So for the following example, ",(0,o.jsx)(n.code,{children:". /src/index.ts"})," corresponds to the path of the build artifacts file as ",(0,o.jsx)(n.code,{children:". /dist/main.js"}),"."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-js",meta:'title="modern.config.ts"',children:"import { defineConfig } from '@modern-js/module-tools';\n\nexport default defineConfig({\n  buildConfig: {\n    input: {\n      main: ['./src/index.ts'],\n    },\n    outDir: './dist',\n  },\n});\n"})}),"\n",(0,o.jsx)(n.p,{children:"The bundleless build process also supports such use, but it is not recommended."}),"\n",(0,o.jsxs)(n.h4,{id:"sourcedir",children:[(0,o.jsx)(n.code,{children:"sourceDir"}),(0,o.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#sourcedir",children:"#"})]}),"\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.a,{href:"/en/api/config/build-config#sourcedir",children:(0,o.jsx)(n.code,{children:"sourceDir"})})," is used to specify the source code directory, which is related to both."]}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"type file generation"}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.a,{href:"https://esbuild.github.io/api/#outbase",target:"_blank",rel:"noopener noreferrer",children:(0,o.jsx)(n.code,{children:"outbase"})})," for specifying the build process"]}),"\n"]}),"\n",(0,o.jsx)(n.p,{children:"In general:"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsxs)(n.strong,{children:["During the bundleless build process, the values of ",(0,o.jsx)(n.code,{children:"sourceDir"})," and ",(0,o.jsx)(n.code,{children:"input"})," should be the same, and their default values are both ",(0,o.jsx)(n.code,{children:"src"})]}),"."]}),"\n",(0,o.jsxs)(n.li,{children:["It is rarely necessary to use ",(0,o.jsx)(n.code,{children:"sourceDir"})," during the bundle build process."]}),"\n"]}),"\n",(0,o.jsxs)(n.h3,{id:"dts",children:["dts",(0,o.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#dts",children:"#"})]}),"\n",(0,o.jsxs)(n.p,{children:["The ",(0,o.jsx)(n.a,{href:"/en/api/config/build-config#dts",children:(0,o.jsx)(n.code,{children:"buildConfig.dts"})})," configuration is mainly used for type file generation."]}),"\n",(0,o.jsxs)(n.h4,{id:"turn-off-type-generation",children:["Turn off type generation",(0,o.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#turn-off-type-generation",children:"#"})]}),"\n",(0,o.jsx)(n.p,{children:"Type generation is turned on by default, if you need to turn it off, you can configure it as follows:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-js",meta:'title="modern.config.ts"',children:"import { defineConfig } from '@modern-js/module-tools';\n\nexport default defineConfig({\n  buildConfig: {\n    dts: false,\n  },\n});\n"})}),"\n",(0,o.jsxs)(n.div,{className:"modern-directive tip",children:[(0,o.jsx)(n.div,{className:"modern-directive-title",children:"TIP"}),(0,o.jsx)(n.div,{className:"modern-directive-content",children:(0,o.jsx)(n.p,{children:"The build speed is generally improved by closing the type file."})})]}),"\n",(0,o.jsxs)(n.h4,{id:"build-type-files",children:["Build type files",(0,o.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#build-type-files",children:"#"})]}),"\n",(0,o.jsxs)(n.p,{children:["With ",(0,o.jsx)(n.code,{children:"buildType: 'bundleless'"}),", type files are generated using the project's ",(0,o.jsx)(n.code,{children:"tsc"})," command to complete production."]}),"\n",(0,o.jsxs)(n.p,{children:["The ",(0,o.jsx)(n.strong,{children:"Module Tools also supports bundling of type files"}),", although care needs to be taken when using this feature."]}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["Some third-party dependencies have incorrect syntax that can cause the bundling process to fail. So in this case, you need to exclude such third-party packages manually with ",(0,o.jsx)(n.a,{href:"/en/api/config/build-config#externals",children:(0,o.jsx)(n.code,{children:"buildConfig.externals"})}),"."]}),"\n",(0,o.jsxs)(n.li,{children:["It is not possible to handle the case where the type file of a third-party dependency points to a ",(0,o.jsx)(n.code,{children:".ts"})," file. For example, the ",(0,o.jsx)(n.code,{children:"package.json"})," of a third-party dependency contains something like this: ",(0,o.jsx)(n.code,{children:'{"types": ". /src/index.ts"}'}),"."]}),"\n"]}),"\n",(0,o.jsxs)(n.h4,{id:"alias-conversion",children:["Alias Conversion",(0,o.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#alias-conversion",children:"#"})]}),"\n",(0,o.jsx)(n.p,{children:"During the bundleless build process, if an alias appears in the source code, e.g."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-js",meta:'title="./src/index.ts"',children:"import utils from '@common/utils';\n"})}),"\n",(0,o.jsxs)(n.p,{children:["Normally, the type files generated with ",(0,o.jsx)(n.code,{children:"tsc"})," will also contain these aliases. However, Module Tools will convert the aliases in the type file generated by ",(0,o.jsx)(n.code,{children:"tsc"})," to:"]}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["Alias conversion is possible for code of the form ",(0,o.jsx)(n.code,{children:"import '@common/utils'"})," or ",(0,o.jsx)(n.code,{children:"import utils from '@common/utils'"}),"."]}),"\n",(0,o.jsxs)(n.li,{children:["Aliasing is possible for code of the form ",(0,o.jsx)(n.code,{children:"export { utils } from '@common/utils'"}),"."]}),"\n"]}),"\n",(0,o.jsxs)(n.p,{children:["However, there are some cases that cannot be handled at this time.Output types of the form ",(0,o.jsx)(n.code,{children:"Promise<import('@common/utils')>"})," cannot be converted at this time.\nYou can discuss it ",(0,o.jsx)(n.a,{href:"https://github.com/web-infra-dev/modern.js/discussions/4511",target:"_blank",rel:"noopener noreferrer",children:"here"})]}),"\n",(0,o.jsxs)(n.h4,{id:"some-examples-of-the-use-of-dts",children:["Some examples of the use of ",(0,o.jsx)(n.code,{children:"dts"}),(0,o.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#some-examples-of-the-use-of-dts",children:"#"})]}),"\n",(0,o.jsx)(n.p,{children:"General usage:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-js",children:"import { defineConfig } from '@modern-js/module-tools';\n\nexport default defineConfig({\n  // The output path of the bundled type file at this point is `./dist/types`\n  buildConfig: {\n    buildType: 'bundle',\n    dts: {\n      tsconfigPath: './other-tsconfig.json',\n      distPath: './types',\n    },\n    outDir: './dist',\n  },\n});\n"})}),"\n",(0,o.jsxs)(n.p,{children:["For the use of ",(0,o.jsx)(n.code,{children:"dts.only"}),":"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-js",children:"import { defineConfig } from '@modern-js/module-tools';\n\nexport default defineConfig({\n  // At this moment the type file is not bundled and the output path is `./dist/types`\n  buildConfig: [\n    {\n      buildType: 'bundle',\n      dts: false,\n      outDir: './dist',\n    },\n    {\n      buildType: 'bundleless',\n      dts: {\n        only: true,\n      },\n      outDir: './dist/types',\n    },\n  ],\n});\n"})}),"\n",(0,o.jsxs)(n.h3,{id:"buildconfigdefine-usage-for-different-scenarios",children:[(0,o.jsx)(n.code,{children:"buildConfig.define"})," Usage for different scenarios",(0,o.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#buildconfigdefine-usage-for-different-scenarios",children:"#"})]}),"\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.a,{href:"/en/api/config/build-config#define",children:(0,o.jsx)(n.code,{children:"buildConfig.define"})})," functions somewhat similar to ",(0,o.jsx)(n.a,{href:"https://webpack.js.org/plugins/define-plugin/",target:"_blank",rel:"noopener noreferrer",children:(0,o.jsx)(n.code,{children:"webpack.DefinePlugin"})}),". A few usage scenarios are described here."]}),"\n",(0,o.jsxs)(n.h4,{id:"environment-variable-replacement",children:["Environment variable replacement",(0,o.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#environment-variable-replacement",children:"#"})]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-js",children:"import { defineConfig } from '@modern-js/module-tools';\nexport default defineConfig({\n  buildConfig: {\n    define: {\n      'process.env.VERSION': JSON.stringify(process.env.VERSION || '0.0.0'),\n    },\n  },\n});\n"})}),"\n",(0,o.jsx)(n.p,{children:"With the above configuration, we can put the following code."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-js",children:"// pre-compiler code\nconsole.log(process.env.VERSION);\n"})}),"\n",(0,o.jsxs)(n.p,{children:["When executing ",(0,o.jsx)(n.code,{children:"VERSION=1.0.0 modern build"}),", the conversion is:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-js",children:"// compiled code\nconsole.log('1.0.0');\n"})}),"\n",(0,o.jsxs)(n.h4,{id:"global-variable-replacement",children:["Global variable replacement",(0,o.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#global-variable-replacement",children:"#"})]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-js",children:"import { defineConfig } from '@modern-js/module-tools';\nexport default defineConfig({\n  buildConfig: {\n    define: {\n      VERSION: JSON.stringify(require('. /package.json').version || '0.0.0'),\n    },\n  },\n});\n"})}),"\n",(0,o.jsx)(n.p,{children:"With the above configuration, we can put the following code."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-js",children:"// pre-compile code\nconsole.log(VERSION);\n"})}),"\n",(0,o.jsx)(n.p,{children:"Convert to:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-js",children:"// post-compile code\nconsole.log('1.0.0');\n"})}),"\n",(0,o.jsxs)(n.p,{children:["Note, however: If the project is a TypeScript project, then you may need to add the following to the ",(0,o.jsx)(n.code,{children:".d.ts"})," file in the project source directory."]}),"\n",(0,o.jsxs)(n.blockquote,{children:["\n",(0,o.jsxs)(n.p,{children:["If the ",(0,o.jsx)(n.code,{children:".d.ts"})," file does not exist, then you can create it manually."]}),"\n"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-ts",meta:'title="env.d.ts"',children:"declare const YOUR_ADD_GLOBAL_VAR;\n"})}),"\n",(0,o.jsxs)(n.h2,{id:"build-process",children:["Build process",(0,o.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#build-process",children:"#"})]}),"\n",(0,o.jsxs)(n.p,{children:["When the ",(0,o.jsx)(n.code,{children:"modern build"})," command is executed, the"]}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["Clear the output directory according to ",(0,o.jsx)(n.code,{children:"buildConfig.outDir"}),"."]}),"\n",(0,o.jsxs)(n.li,{children:["Compile ",(0,o.jsx)(n.code,{children:"js/ts"})," source code to generate the JS build artifacts for bundle/bundleless."]}),"\n",(0,o.jsxs)(n.li,{children:["Generate bundle/bundleless type files using ",(0,o.jsx)(n.code,{children:"tsc"}),"."]}),"\n",(0,o.jsx)(n.li,{children:"Handle Copy tasks."}),"\n"]}),"\n",(0,o.jsxs)(n.h2,{id:"build-errors",children:["Build errors",(0,o.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#build-errors",children:"#"})]}),"\n",(0,o.jsx)(n.p,{children:"When a build error occurs, based on the information learned above, it is easy to understand what error appears in the terminal."}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.strong,{children:"Errors reported for js or ts builds:"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:'error  ModuleBuildError:\n\n╭───────────────────────╮\n│ bundle failed:        │\n│  - format is "cjs"    │\n│  - target is "esnext" │\n╰───────────────────────╯\n\nDetailed Information:\n'})}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.strong,{children:"Errors reported for the type file generation process:"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"error   ModuleBuildError:\n\nbundle DTS failed:\n"})}),"\n",(0,o.jsxs)(n.p,{children:["For ",(0,o.jsx)(n.code,{children:"js/ts"})," build errors, we can tell from the error message."]}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["By ",(0,o.jsx)(n.code,{children:"'bundle failed:'"})," to determine if the error is reported for a bundle build or a bundleless build"]}),"\n",(0,o.jsxs)(n.li,{children:["What is the ",(0,o.jsx)(n.code,{children:"format"})," of the build process"]}),"\n",(0,o.jsxs)(n.li,{children:["What is the ",(0,o.jsx)(n.code,{children:"target"})," of the build process"]}),"\n",(0,o.jsx)(n.li,{children:"The specific error message"}),"\n"]})]})}(s=globalThis).__RSPRESS_PAGE_META||(s.__RSPRESS_PAGE_META={}),globalThis.__RSPRESS_PAGE_META["en%2Fguide%2Fadvance%2Fin-depth-about-build.md"]={toc:[{text:"buildConfig",id:"buildconfig",depth:2},{text:"bundle / bundleless",id:"bundle--bundleless",depth:3},{text:"input / sourceDir",id:"input--sourcedir",depth:3},{text:"Object type of input",id:"object-type-of-input",depth:4},{text:"sourceDir",id:"sourcedir",depth:4},{text:"dts",id:"dts",depth:3},{text:"Turn off type generation",id:"turn-off-type-generation",depth:4},{text:"Build type files",id:"build-type-files",depth:4},{text:"Alias Conversion",id:"alias-conversion",depth:4},{text:"Some examples of the use of dts",id:"some-examples-of-the-use-of-dts",depth:4},{text:"buildConfig.define Usage for different scenarios",id:"buildconfigdefine-usage-for-different-scenarios",depth:3},{text:"Environment variable replacement",id:"environment-variable-replacement",depth:4},{text:"Global variable replacement",id:"global-variable-replacement",depth:4},{text:"Build process",id:"build-process",depth:2},{text:"Build errors",id:"build-errors",depth:2}],title:"In-depth understanding of build",frontmatter:{sidebar_position:1}};var c=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=Object.assign({},(0,l.useMDXComponents)(),e.components).wrapper;return n?(0,o.jsx)(n,(0,r._)((0,d._)({},e),{children:(0,o.jsx)(t,(0,d._)({},e))})):t(e)}}}]);