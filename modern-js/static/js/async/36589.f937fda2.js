/*! For license information please see 36589.f937fda2.js.LICENSE.txt */
(self.webpackChunk_modern_js_main_doc=self.webpackChunk_modern_js_main_doc||[]).push([["36589"],{57995:function(e,n,r){"use strict";r.r(n);var s=r("39980"),t=r("96954");function a(e){let n=Object.assign({h1:"h1",a:"a",p:"p",h2:"h2",code:"code",div:"div",ul:"ul",li:"li",h3:"h3",pre:"pre",h4:"h4",ol:"ol",strong:"strong"},(0,t.useMDXComponents)(),e.components);return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(n.h1,{id:"data-fetching",children:["Data Fetching",(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#data-fetching",children:"#"})]}),"\n",(0,s.jsx)(n.p,{children:"Modern.js provides out-of-the-box data fetching capabilities,developers can fetch data in the project through these APIs."}),"\n",(0,s.jsx)(n.p,{children:"It should be noted that these APIs do not help applications initiate requests, but rather help developers better manage data and improve project performance."}),"\n",(0,s.jsxs)(n.h2,{id:"data-loader-recommended",children:["Data Loader (Recommended)",(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#data-loader-recommended",children:"#"})]}),"\n",(0,s.jsxs)(n.p,{children:["Modern.js recommends using ",(0,s.jsx)(n.a,{href:"/guides/basic-features/routes",children:"conventional routing"})," for routing management. Through Modern.js's ",(0,s.jsx)(n.a,{href:"/guides/basic-features/routes#conventional-routing",children:"conventional (nested) routing"}),", each routing component (",(0,s.jsx)(n.code,{children:"layout.ts"})," or ",(0,s.jsx)(n.code,{children:"page.ts"}),") can have a same-named ",(0,s.jsx)(n.code,{children:"loader"})," file. The ",(0,s.jsx)(n.code,{children:"loader"})," file needs to export a function that will be executed before the component is rendered to provide data for the routing component."]}),"\n",(0,s.jsxs)(n.div,{className:"rspress-directive info",children:[(0,s.jsx)(n.div,{className:"rspress-directive-title",children:"INFO"}),(0,s.jsxs)(n.div,{className:"rspress-directive-content",children:[(0,s.jsxs)(n.p,{children:["Modern.js v1 supports fetching data via ",(0,s.jsx)(n.a,{href:"/guides/basic-features/data/data-fetch#useloader-(old-version)",children:"useLoader"}),", which is no longer the recommended usage. We do not recommend mixing the two except during the migration process."]}),"\n"]})]}),"\n",(0,s.jsxs)(n.div,{className:"rspress-directive warning",children:[(0,s.jsx)(n.div,{className:"rspress-directive-title",children:"WARNING"}),(0,s.jsxs)(n.div,{className:"rspress-directive-content",children:["\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["In the previous version, Modern.js Data Loader was defined in the ",(0,s.jsx)(n.code,{children:"loader"})," file. In later versions, we recommend defining it in the ",(0,s.jsx)(n.code,{children:"data"})," file, while we will maintain compatibility with the ",(0,s.jsx)(n.code,{children:"loader"})," file."]}),"\n",(0,s.jsxs)(n.li,{children:["In the ",(0,s.jsx)(n.code,{children:"data"})," file, the corresponding ",(0,s.jsx)(n.code,{children:"loader"})," needs to be exported with a name\u3002"]}),"\n"]}),"\n"]})]}),"\n",(0,s.jsxs)(n.h3,{id:"basic-example",children:["Basic Example",(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#basic-example",children:"#"})]}),"\n",(0,s.jsxs)(n.p,{children:["Routing components such as ",(0,s.jsx)(n.code,{children:"layout.ts"})," or ",(0,s.jsx)(n.code,{children:"page.ts"})," can define a same-named ",(0,s.jsx)(n.code,{children:"loader"})," file. The function exported by the ",(0,s.jsx)(n.code,{children:"data"})," file provides the data required by the component, and then the data is obtained in the routing component through the ",(0,s.jsx)(n.code,{children:"useLoaderData"})," function, as shown in the following example:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:".\n\u2514\u2500\u2500 routes\n    \u251C\u2500\u2500 layout.tsx\n    \u2514\u2500\u2500 user\n        \u251C\u2500\u2500 layout.tsx\n        \u251C\u2500\u2500 layout.data.ts\n        \u251C\u2500\u2500 page.tsx\n        \u2514\u2500\u2500 page.data.ts\n"})}),"\n",(0,s.jsx)(n.p,{children:"Define the following code in the file:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",meta:'title="routes/user/page.tsx"',children:"import { useLoaderData } from '@modern-js/runtime/router';\nimport type { ProfileData } from './page.data.ts';\n\nexport default function UserPage() {\n  const profileData = useLoaderData() as ProfileData;\n  return <div>{profileData}</div>;\n}\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",meta:'title="routes/user/page.data.ts"',children:"export type ProfileData = {\n  /*  some types */\n};\n\nexport const loader = async (): Promise<ProfileData> => {\n  const res = await fetch('https://api/user/profile');\n  return await res.json();\n};\n"})}),"\n",(0,s.jsxs)(n.div,{className:"rspress-directive caution",children:[(0,s.jsx)(n.div,{className:"rspress-directive-title",children:"CAUTION"}),(0,s.jsxs)(n.div,{className:"rspress-directive-content",children:[(0,s.jsxs)(n.p,{children:["Here, routing components and ",(0,s.jsx)(n.code,{children:"data"})," files share a type, so the ",(0,s.jsx)(n.code,{children:"import type"})," syntax should be used."]}),"\n"]})]}),"\n",(0,s.jsxs)(n.p,{children:["In the CSR environment, the ",(0,s.jsx)(n.code,{children:"loader"})," function is executed on the client and can use browser APIs (although it is not necessary and not recommended)."]}),"\n",(0,s.jsxs)(n.p,{children:["In the SSR environment, whether it is the first screen or client navigation, the ",(0,s.jsx)(n.code,{children:"loader"})," function will only be executed on the server, and any Node.js API can be called here. Also, any dependencies and code used here will not be included in the client's bundle."]}),"\n",(0,s.jsxs)(n.div,{className:"rspress-directive info",children:[(0,s.jsx)(n.div,{className:"rspress-directive-title",children:"INFO"}),(0,s.jsxs)(n.div,{className:"rspress-directive-content",children:[(0,s.jsxs)(n.p,{children:["In future versions, Modern.js may support running the ",(0,s.jsx)(n.code,{children:"loader"})," function on the server in the CSR environment to improve performance and security. Therefore, it is recommended to ensure that the ",(0,s.jsx)(n.code,{children:"loader"})," function is as pure as possible and only used for data fetching scenarios."]}),"\n"]})]}),"\n",(0,s.jsxs)(n.p,{children:["When navigating on the client based on Modern.js's ",(0,s.jsx)(n.a,{href:"/guides/basic-features/routes",children:"conventional routing"}),", all ",(0,s.jsx)(n.code,{children:"loader"})," functions will be executed in parallel (requested). That is, when accessing ",(0,s.jsx)(n.code,{children:"/user/profile"}),", the loader functions under ",(0,s.jsx)(n.code,{children:"/user"})," and ",(0,s.jsx)(n.code,{children:"/user/profile"})," will be executed in parallel (requested) to improve the performance of the client."]}),"\n",(0,s.jsxs)(n.h3,{id:"the-loader-function",children:["The ",(0,s.jsx)(n.code,{children:"loader"})," Function",(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#the-loader-function",children:"#"})]}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"loader"})," function has two input parameters:"]}),"\n",(0,s.jsxs)(n.h4,{id:"params",children:[(0,s.jsx)(n.code,{children:"params"}),(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#params",children:"#"})]}),"\n",(0,s.jsxs)(n.p,{children:["When the route file is accessed through ",(0,s.jsx)(n.code,{children:"[]"}),", it is used as ",(0,s.jsx)(n.a,{href:"/guides/basic-features/routes#dynamic-routing",children:"dynamic routing"}),", and the dynamic routing fragment is passed as a parameter to the ",(0,s.jsx)(n.code,{children:"loader"})," function:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-tsx",children:"// routes/user/[id]/page.data.tsx\nimport { LoaderFunctionArgs } from '@modern-js/runtime/router';\n\nexport default async ({ params }: LoaderFunctionArgs) => {\n  const { id } = params;\n  const res = await fetch(`https://api/user/${id}`);\n  return res.json();\n};\n"})}),"\n",(0,s.jsxs)(n.p,{children:["When accessing ",(0,s.jsx)(n.code,{children:"/user/123"}),", the parameter of the ",(0,s.jsx)(n.code,{children:"loader"})," function is ",(0,s.jsx)(n.code,{children:"{ params: { id: '123' } }"}),"."]}),"\n",(0,s.jsxs)(n.h4,{id:"request",children:[(0,s.jsx)(n.code,{children:"request"}),(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#request",children:"#"})]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"request"})," is a ",(0,s.jsx)(n.a,{href:"https://developer.mozilla.org/en-US/docs/Web/API/Request",target:"_blank",rel:"noopener noreferrer",children:"Fetch Request"})," instance."]}),"\n",(0,s.jsxs)(n.p,{children:["A common usage scenario is to get query parameters through ",(0,s.jsx)(n.code,{children:"request"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-tsx",children:"// routes/user/[id]/page.data.ts\nimport { LoaderFunctionArgs } from '@modern-js/runtime/router';\n\nexport const loader = async ({ request }: LoaderFunctionArgs) => {\n  const url = new URL(request.url);\n  const userId = url.searchParams.get('id');\n  return queryUser(userId);\n};\n"})}),"\n",(0,s.jsxs)(n.h4,{id:"return-value",children:["Return Value",(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#return-value",children:"#"})]}),"\n",(0,s.jsxs)(n.p,{children:["The return value of the ",(0,s.jsx)(n.code,{children:"loader"})," function can be any serializable content or a ",(0,s.jsx)(n.a,{href:"https://developer.mozilla.org/en-US/docs/Web/API/Response",target:"_blank",rel:"noopener noreferrer",children:"Fetch Response"})," instance:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-tsx",children:"const loader = async (): Promise<ProfileData> => {\n  return {\n    message: 'hello world',\n  };\n};\nexport default loader;\n"})}),"\n",(0,s.jsxs)(n.p,{children:["By default, the ",(0,s.jsx)(n.code,{children:"Content-type"})," of the response returned by the ",(0,s.jsx)(n.code,{children:"loader"})," is ",(0,s.jsx)(n.code,{children:"application/json"}),", and the ",(0,s.jsx)(n.code,{children:"status"})," is 200. You can customize the ",(0,s.jsx)(n.code,{children:"Response"})," to set it:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-tsx",children:"const loader = async (): Promise<ProfileData> => {\n  const data = { message: 'hello world' };\n  return new Response(JSON.stringify(data), {\n    status: 200,\n    headers: {\n      'Content-Type': 'application/json; utf-8',\n    },\n  });\n};\n"})}),"\n",(0,s.jsxs)(n.h3,{id:"request-api",children:["Request API",(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#request-api",children:"#"})]}),"\n",(0,s.jsxs)(n.p,{children:["Modern.js provides a polyfill for the ",(0,s.jsx)(n.code,{children:"fetch"})," API to make requests. This API is consistent with the browser's ",(0,s.jsx)(n.code,{children:"fetch"})," API, but can also be used to make requests on the server. This means that whether it is CSR or SSR, a unified ",(0,s.jsx)(n.code,{children:"fetch"})," API can be used to get data:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-tsx",children:"function loader() {\n  const res = await fetch('https://api/user/profile');\n}\n"})}),"\n",(0,s.jsxs)(n.h3,{id:"error-handling",children:["Error Handling",(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#error-handling",children:"#"})]}),"\n",(0,s.jsxs)(n.p,{children:["In the ",(0,s.jsx)(n.code,{children:"loader"})," function, errors can be handled by throwing an ",(0,s.jsx)(n.code,{children:"error"})," or a ",(0,s.jsx)(n.code,{children:"response"}),". When an error is thrown in the ",(0,s.jsx)(n.code,{children:"loader"})," function, Modern.js will stop executing the code in the current ",(0,s.jsx)(n.code,{children:"loader"})," and switch the front-end UI to the defined ",(0,s.jsx)(n.a,{href:"/guides/basic-features/routes#error-handling",children:(0,s.jsx)(n.code,{children:"ErrorBoundary"})})," component:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-tsx",children:"// routes/user/profile/page.data.tsx\nexport const loader = async function loader() {\n  const res = await fetch('https://api/user/profile');\n  if (!res.ok) {\n    throw res;\n  }\n  return res.json();\n}\n\n// routes/user/profile/error.tsx\nimport { useRouteError } from '@modern-js/runtime/router';\nconst ErrorBoundary = () => {\n  const error = useRouteError() as Response;\n  return (\n    <div>\n      <h1>{error.status}</h1>\n      <h2>{error.statusText}</h2>\n    </div>\n  );\n};\n\nexport default ErrorBoundary;\n"})}),"\n",(0,s.jsxs)(n.h3,{id:"get-data-from-parent-component",children:["Get data from parent component",(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#get-data-from-parent-component",children:"#"})]}),"\n",(0,s.jsxs)(n.p,{children:["In many cases, child components need to access data in the parent component ",(0,s.jsx)(n.code,{children:"loader"}),". You can easily get the data from the parent component using ",(0,s.jsx)(n.code,{children:"useRouteLoaderData"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-tsx",children:"// routes/user/profile/page.tsx\nimport { useRouteLoaderData } from '@modern-js/runtime/router';\n\nexport default function UserLayout() {\n  // Get the data returned by the loader in routes/user/layout.data.ts\n  const data = useRouteLoaderData('user/layout');\n  return (\n    <div>\n      <h1>{data.name}</h1>\n      <h2>{data.age}</h2>\n    </div>\n  );\n}\n"})}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"useRouteLoaderData"})," function accepts a parameter ",(0,s.jsx)(n.code,{children:"routeId"}),". When using ",(0,s.jsx)(n.a,{href:"/guides/basic-features/routes",children:"conventional routing"}),", Modern.js will automatically generate the ",(0,s.jsx)(n.code,{children:"routeId"})," for you. The value of ",(0,s.jsx)(n.code,{children:"routeId"})," is the path of the corresponding component relative to ",(0,s.jsx)(n.code,{children:"src/routes"}),". For example, in the above example, if the child component wants to get the data returned by the loader in ",(0,s.jsx)(n.code,{children:"routes/user/layout.tsx"}),", the value of ",(0,s.jsx)(n.code,{children:"routeId"})," is ",(0,s.jsx)(n.code,{children:"user/layout"}),"."]}),"\n",(0,s.jsxs)(n.p,{children:["In a multi-entry (MPA) scenario, the value of ",(0,s.jsx)(n.code,{children:"routeId"})," needs to include the name of the corresponding entry. Unless specified, the entry name is generally the name of the entry directory. For example, in the following directory structure:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:".\n\u2514\u2500\u2500 src\n    \u251C\u2500\u2500 entry1\n    \u2502     \u2514\u2500\u2500 routes\n    \u2502           \u2514\u2500\u2500 layout.tsx\n    \u2514\u2500\u2500 entry2\n          \u2514\u2500\u2500 routes\n                \u2514\u2500\u2500 layout.tsx\n"})}),"\n",(0,s.jsxs)(n.p,{children:["If you want to get the data returned by the ",(0,s.jsx)(n.code,{children:"loader"})," in ",(0,s.jsx)(n.code,{children:"entry1/routes/layout.tsx"}),", the value of ",(0,s.jsx)(n.code,{children:"routeId"})," is ",(0,s.jsx)(n.code,{children:"entry1_layout"}),"."]}),"\n",(0,s.jsxs)(n.h3,{id:"wiploading-ui",children:["(WIP)Loading UI",(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#wiploading-ui",children:"#"})]}),"\n",(0,s.jsxs)(n.div,{className:"rspress-directive info",children:[(0,s.jsx)(n.div,{className:"rspress-directive-title",children:"INFO"}),(0,s.jsx)(n.div,{className:"rspress-directive-content",children:(0,s.jsx)(n.p,{children:"This feature is currently experimental and the API may change in the future."})})]}),"\n",(0,s.jsxs)(n.p,{children:["Create ",(0,s.jsx)(n.code,{children:"user/layout.data.ts"})," and add the following code:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",meta:'title="routes/user/layout.data.ts"',children:"import { defer } from '@modern-js/runtime/router';\n\nexport const loader = () =>\n  defer({\n    userInfo: new Promise(resolve => {\n      setTimeout(() => {\n        resolve({\n          age: 1,\n          name: 'user layout',\n        });\n      }, 1000);\n    }),\n  });\n\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Add the following code in ",(0,s.jsx)(n.code,{children:"user/layout.tsx"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-tsx",meta:'title="routes/user/layout.tsx"',children:"import {\n  Await,\n  defer,\n  useLoaderData,\n  Outlet\n} from '@modern-js/runtime/router';\n\nexport default function UserLayout() {\n  const { userInfo } = useLoaderData() as {userInfo: Promise<UserInfo>};\n  return (\n    <div>\n      <React.Suspense\n        fallback={<p>Loading...</p>}\n      >\n        <Await resolve={userInfo} children={userInfo => (\n          <div>\n            <span>{userInfo.name}</span>\n            <span>{userInfo.age}</span>\n            <Outlet/>\n          </div>\n        )}>\n        </Await>\n      </React.Suspense>\n    </div>\n  );\n}\n"})}),"\n",(0,s.jsxs)(n.div,{className:"rspress-directive info",children:[(0,s.jsx)(n.div,{className:"rspress-directive-title",children:"INFO"}),(0,s.jsxs)(n.div,{className:"rspress-directive-content",children:[(0,s.jsxs)(n.p,{children:["For details on how to use the Await component, please refer to ",(0,s.jsx)(n.a,{href:"https://reactrouter.com/en/main/components/await",target:"_blank",rel:"noopener noreferrer",children:"Await"}),"."]}),"\n",(0,s.jsxs)(n.p,{children:["For details on how to use defer, please refer to ",(0,s.jsx)(n.a,{href:"https://reactrouter.com/en/main/guides/deferred",target:"_blank",rel:"noopener noreferrer",children:"defer"}),".\n"]})]})]}),"\n",(0,s.jsxs)(n.h3,{id:"data-cache",children:["Data Cache",(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#data-cache",children:"#"})]}),"\n",(0,s.jsxs)(n.p,{children:["In routing navigation, Modern.js will only load the data of the changed part of the route.\nFor example, the current route is ",(0,s.jsx)(n.code,{children:"a/b"}),", and the Data Loader corresponding to the ",(0,s.jsx)(n.code,{children:"a"})," path has been executed.\nWhen jumping from ",(0,s.jsx)(n.code,{children:"/a/b"})," to ",(0,s.jsx)(n.code,{children:"/a/c"}),", the Data Loader corresponding to ",(0,s.jsx)(n.code,{children:"a"})," path will not be re-executed,\nand the Data Loader corresponding to ",(0,s.jsx)(n.code,{children:"c"})," path will execute and fetch the data."]}),"\n",(0,s.jsx)(n.p,{children:"It is mean that Modern.js will only load the data for the routing change portion of the data load,\nand this default optimization strategy avoids invalid duplicate data requests."}),"\n",(0,s.jsxs)(n.p,{children:["You may ask, how to update the data of the ",(0,s.jsx)(n.code,{children:"a"})," path corresponding to the Data Loader?"]}),"\n",(0,s.jsx)(n.p,{children:"In Modern.js, Modern.js will reload the data of the corresponding routing path in the following cases:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["After ",(0,s.jsx)(n.a,{href:"/guides/basic-features/data/data-write",children:"Data Action"})," is triggered"]}),"\n",(0,s.jsx)(n.li,{children:"The search params on the url have changed."}),"\n",(0,s.jsx)(n.li,{children:"The link clicked by the user is the same as the URL of the current page."}),"\n",(0,s.jsxs)(n.li,{children:["The ",(0,s.jsx)(n.a,{href:"#/shouldrevalidate",children:(0,s.jsx)(n.code,{children:"shouldRevalidate"})})," function is defined in the routing component, which returns true"]}),"\n"]}),"\n",(0,s.jsxs)(n.div,{className:"rspress-directive info",children:[(0,s.jsx)(n.div,{className:"rspress-directive-title",children:"INFO"}),(0,s.jsx)(n.div,{className:"rspress-directive-content",children:(0,s.jsxs)(n.p,{children:["If you define the ",(0,s.jsx)(n.a,{href:"#/shouldrevalidate",children:(0,s.jsx)(n.code,{children:"shouldRevalidate"})})," function on the route, the function will be checked first to determine whether the data needs to be reloaded.\n"]})})]}),"\n",(0,s.jsxs)(n.h3,{id:"shouldrevalidate",children:[(0,s.jsx)(n.code,{children:"shouldRevalidate"}),(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#shouldrevalidate",children:"#"})]}),"\n",(0,s.jsxs)(n.div,{className:"rspress-directive warning",children:[(0,s.jsx)(n.div,{className:"rspress-directive-title",children:"WARNING"}),(0,s.jsx)(n.div,{className:"rspress-directive-content",children:(0,s.jsxs)(n.p,{children:["Currently ",(0,s.jsx)(n.code,{children:"shouldRevalidate"})," works under csr and streaming ssr.\n"]})})]}),"\n",(0,s.jsxs)(n.p,{children:["In each routing component (",(0,s.jsx)(n.code,{children:"layout.tsx"}),", ",(0,s.jsx)(n.code,{children:"page.tsx"}),", ",(0,s.jsx)(n.code,{children:"$.tsx"}),"), we can export a ",(0,s.jsx)(n.code,{children:"shouldRevalidate"})," function, which is triggered each time a route changes in the project. This function controls which routes' data are reloaded, and when it returns true, the data for the corresponding route is reloaded. data of the corresponding route will be reloaded."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",meta:'title="routes/user/layout.tsx"',children:"import type { ShouldRevalidateFunction } from '@modern-js/runtime/router';\nexport const shouldRevalidate: ShouldRevalidateFunction = ({\n  actionResult,\n  currentParams,\n  currentUrl,\n  defaultShouldRevalidate,\n  formAction,\n  formData,\n  formEncType,\n  formMethod,\n  nextParams,\n  nextUrl,\n}) => {\n  return true;\n};\n"})}),"\n",(0,s.jsxs)(n.div,{className:"rspress-directive info",children:[(0,s.jsx)(n.div,{className:"rspress-directive-title",children:"INFO"}),(0,s.jsx)(n.div,{className:"rspress-directive-content",children:(0,s.jsxs)(n.p,{children:["For more details about the ",(0,s.jsx)(n.code,{children:"shouldRevalidate"})," function, please refer to ",(0,s.jsx)(n.a,{href:"https://reactrouter.com/en/main/route/should-revalidate",target:"_blank",rel:"noopener noreferrer",children:"react-router"}),"\n"]})})]}),"\n",(0,s.jsxs)(n.h3,{id:"client-loader",children:["Client Loader",(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#client-loader",children:"#"})]}),"\n",(0,s.jsxs)(n.div,{className:"rspress-directive info",children:[(0,s.jsx)(n.div,{className:"rspress-directive-title",children:"INFO"}),(0,s.jsxs)(n.div,{className:"rspress-directive-content",children:["\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"This feature requires version x.36.0 or above, and it\u2018s recommended to use the latest version of the framework."}),"\n",(0,s.jsx)(n.li,{children:"Only SSR projects have Client Loaders, while in CSR projects, it can be considered as the default Client Loader."}),"\n",(0,s.jsx)(n.li,{children:"This feature can be used progressively and not every project needs it. For specific information, please refer to the explanation of applicable scenarios in the document below."}),"\n"]}),"\n"]})]}),"\n",(0,s.jsxs)(n.h4,{id:"applicable-scenarios",children:["Applicable scenarios",(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#applicable-scenarios",children:"#"})]}),"\n",(0,s.jsx)(n.p,{children:"In the SSR project, the code in Data Loader will only be executed on the server side when the client performs SPA navigation.\nThe framework will send an HTTP request to the SSR service to trigger the execution of Data Loader.\nHowever, in some scenarios, we may expect that requests sent by clients do not go through the SSR service and directly request data sources."}),"\n",(0,s.jsxs)(n.div,{className:"rspress-directive info",children:[(0,s.jsx)(n.div,{className:"rspress-directive-title",children:"INFO"}),(0,s.jsxs)(n.div,{className:"rspress-directive-content",children:[(0,s.jsxs)(n.p,{children:["Why the Data Loader is only executed server-side in SSR projects can be found in ",(0,s.jsx)(n.a,{href:"#faq",children:"FAQ"})]}),"\n"]})]}),"\n",(0,s.jsx)(n.p,{children:"For example, the following scenarios:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"During SSR degradation, it is not desired for the framework to send requests to the SSR service to obtain data. Instead, direct requests to the data source are preferred."}),"\n",(0,s.jsx)(n.li,{children:"There is some cache on the client side, and we don't want to request SSR service to fetch data."}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"In these scenarios, we can use Client Loader. After adding the Client Loader, in the following scenarios, the code in the Client Loader will be called instead of sending requests to SSR services:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"After SSR is downgraded to CSR, when fetch data on the client side, Client Loader will be executed instead of the framework sending requests to Data Loader (Server) to fetch data."}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"When performing SPA navigation in SSR projects and fetch data, Client Loader will be executed."}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.h3,{id:"incorrect-usage",children:["Incorrect usage",(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#incorrect-usage",children:"#"})]}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["The ",(0,s.jsx)(n.code,{children:"loader"})," can only return serializable data. In the SSR environment, the return value of the ",(0,s.jsx)(n.code,{children:"loader"})," function will be serialized as a JSON string and then deserialized into an object on the client side. Therefore, the ",(0,s.jsx)(n.code,{children:"loader"})," function cannot return non-serializable data (such as functions)."]}),"\n"]}),"\n",(0,s.jsxs)(n.div,{className:"rspress-directive warning",children:[(0,s.jsx)(n.div,{className:"rspress-directive-title",children:"WARNING"}),(0,s.jsx)(n.div,{className:"rspress-directive-content",children:(0,s.jsx)(n.p,{children:"Currently, there is no such restriction under CSR, but we strongly recommend that you follow this restriction, and we may also add this restriction under CSR in the future."})})]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"// This won't work!\nexport const loader = async () => {\n  const res = fetch('https://api/user/profile');\n  return res.json();\n};\n\nimport { loader } from './page.data.ts';\nexport default function RouteComp() {\n  const data = loader();\n}\n"})}),"\n",(0,s.jsxs)(n.ol,{start:"2",children:["\n",(0,s.jsxs)(n.li,{children:["Modern.js will call the ",(0,s.jsx)(n.code,{children:"loader"})," function for you, so you should not call the ",(0,s.jsx)(n.code,{children:"loader"})," function yourself:"]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-tsx",children:"// This won't work!\nexport const loader = async () => {\n  const res = fetch('https://api/user/profile');\n  return res.json();\n};\n\nimport { loader } from './page.data.ts';\nexport default function RouteComp() {\n  const data = loader();\n}\n"})}),"\n",(0,s.jsxs)(n.ol,{start:"3",children:["\n",(0,s.jsxs)(n.li,{children:["You should not import the loader file from the route component, and you should also avoid importing variables from the route component into the loader file. If you need to share types, you should use ",(0,s.jsx)(n.code,{children:"import type"}),"."]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"// Not allowed\n// routes/layout.tsx\nimport { useLoaderData } from '@modern-js/runtime/router';\nimport { ProfileData } from './page.data.ts'; // should use \"import type\" instead\n\nexport const fetch = wrapFetch(fetch);\n\nexport default function UserPage() {\n  const profileData = useLoaderData() as ProfileData;\n  return <div>{profileData}</div>;\n}\n\n// routes/layout.data.ts\nimport { fetch } from './layout.tsx'; // should not be imported from the routing component\nexport type ProfileData = {\n  /*  some types */\n};\n\nexport default async (): Promise<ProfileData> => {\n  const res = await fetch('https://api/user/profile');\n  return await res.json();\n};\n"})}),"\n",(0,s.jsxs)(n.ol,{start:"4",children:["\n",(0,s.jsxs)(n.li,{children:["When running on the server, the ",(0,s.jsx)(n.code,{children:"loader"})," function will be bundled into a unified bundle, so we do not recommend using ",(0,s.jsx)(n.code,{children:"__filename"})," and ",(0,s.jsx)(n.code,{children:"__dirname"})," in server-side code."]}),"\n"]}),"\n",(0,s.jsxs)(n.h3,{id:"faq",children:["FAQ",(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#faq",children:"#"})]}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["Relationship between ",(0,s.jsx)(n.code,{children:"loader"})," and BFF functions"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["In CSR projects, ",(0,s.jsx)(n.code,{children:"loader"})," is executed on the client side, and the BFF function can be called directly in the ",(0,s.jsx)(n.code,{children:"loader"})," to make interface requests."]}),"\n",(0,s.jsxs)(n.p,{children:["In SSR projects, each ",(0,s.jsx)(n.code,{children:"loader"})," is also a server-side interface. We recommend using the ",(0,s.jsx)(n.code,{children:"loader"})," instead of the BFF function with an http method of ",(0,s.jsx)(n.code,{children:"get"})," as the interface layer to avoid an extra layer of forwarding and execution."]}),"\n",(0,s.jsxs)(n.ol,{start:"2",children:["\n",(0,s.jsx)(n.li,{children:"Why is the Data Loader only executed on the server-side in SSR projects?"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"The Data Loader in our SSR project is designed to only run on the server side. The main reasons for sending requests from the client to the server during client-side rendering are as follows:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Simplified usage"}),", when using a server loader, the data fetching code for both the SSR and CSR phases is in the server loader (the real calls are made by the framework layer), and the code in the server loader doesn't need to care whether it's in a browser environment or a server-side environment."]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Reducing data for network requests"}),", The server loader can be used as a BFF layer, which reduces the amount of data that needs to be fetched by the front-end at runtime."]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Reduce client-side bundle size"}),", moving the logic code and its dependencies from the client to the server."]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Improve maintainability"}),", moving the logic code to the server side reduces the direct impact of data logic on the front-end UI. In addition, the problem of mistakenly introducing server-side dependencies in the client-side bundle or client-side dependencies in the server-side bundle is also avoided."]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.h2,{id:"useloader-old-version",children:["useLoader (old version)",(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#useloader-old-version",children:"#"})]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.code,{children:"useLoader"})})," is a legacy API in Modern.js v1. This API is a React Hook designed specifically for SSR applications, allowing developers to fetch data in components in isomorphic development."]}),"\n",(0,s.jsxs)(n.div,{className:"rspress-directive tip",children:[(0,s.jsx)(n.div,{className:"rspress-directive-title",children:"TIP"}),(0,s.jsx)(n.div,{className:"rspress-directive-content",children:(0,s.jsxs)(n.p,{children:["It is not necessary to use ",(0,s.jsx)(n.code,{children:"useLoader"})," to fetch data in CSR projects.\n"]})})]}),"\n",(0,s.jsx)(n.p,{children:"Here is the simplest example:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-tsx",children:"import { useLoader } from '@modern-js/runtime';\n\nexport default () => {\n  const { data } = useLoader(async () => {\n    console.log('fetch in useLoader');\n\n    // No real request is sent here, just a hard coding data is returned.\n    // In a real project, the data obtained from the remote end should be returned.\n    return {\n      name: 'Modern.js',\n    };\n  });\n\n  return <div>Hello, {data?.name}</div>;\n};\n"})}),"\n",(0,s.jsx)(n.p,{children:"After running the above code, when you access the page, you can see that logs are output to the terminal, but not printed in the browser console."}),"\n",(0,s.jsxs)(n.p,{children:["This is because Modern.js collects the data returned by ",(0,s.jsx)(n.code,{children:"useLoader"})," during server-side rendering and injects it into the corresponding HTML. If the SSR rendering is successful, you can see the following code snippet in the HTML:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-html",children:"<script>\n  window._SSR_DATA = {};\n<\/script>\n"})}),"\n",(0,s.jsxs)(n.p,{children:["This global variable is used to record data, and during the browser-side rendering process, this data is used first. If the data does not exist, the ",(0,s.jsx)(n.code,{children:"useLoader"})," function will be executed again."]}),"\n",(0,s.jsxs)(n.div,{className:"rspress-directive note",children:[(0,s.jsx)(n.div,{className:"rspress-directive-title",children:"NOTE"}),(0,s.jsx)(n.div,{className:"rspress-directive-content",children:(0,s.jsxs)(n.p,{children:["During the build phase, Modern.js will automatically generate a Loader ID for each ",(0,s.jsx)(n.code,{children:"useLoader"})," and inject it into the SSR and CSR JS Bundles to associate the Loader with the data.\n"]})})]}),"\n",(0,s.jsxs)(n.p,{children:["Compared to ",(0,s.jsx)(n.code,{children:"getServerSideProps"})," in Next.js, which fetches data before rendering, using ",(0,s.jsx)(n.code,{children:"useLoader"})," allows you to get data required for local UI in the component without passing data through multiple layers. Similarly, you don't have to add redundant logic to the outermost data acquisition function because different routes require different data requests. Of course, ",(0,s.jsx)(n.code,{children:"useLoader"})," also has some issues, such as difficulties in server-side code tree shaking and the need for an additional pre-rendering step on the server."]}),"\n",(0,s.jsxs)(n.p,{children:["In the new version of Modern.js, a new Loader solution has been designed. The new solution solves these problems and can be optimized for page performance in conjunction with ",(0,s.jsx)(n.a,{href:"/guides/basic-features/routes",children:"conventional routing"}),"."]}),"\n",(0,s.jsxs)(n.div,{className:"rspress-directive note",children:[(0,s.jsx)(n.div,{className:"rspress-directive-title",children:"NOTE"}),(0,s.jsx)(n.div,{className:"rspress-directive-content",children:(0,s.jsxs)(n.p,{children:["For detailed API information, see ",(0,s.jsx)(n.a,{href:"/apis/app/runtime/core/use-loader",children:"useLoader"}),".\n"]})})]})]})}function i(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:n}=Object.assign({},(0,t.useMDXComponents)(),e.components);return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(a,{...e})}):a(e)}n.default=i,i.__RSPRESS_PAGE_META={},i.__RSPRESS_PAGE_META["en%2Fguides%2Fbasic-features%2Fdata%2Fdata-fetch.mdx"]={toc:[{text:"Data Loader (Recommended)",id:"data-loader-recommended",depth:2},{text:"Basic Example",id:"basic-example",depth:3},{text:"The `loader` Function",id:"the-loader-function",depth:3},{text:"`params`",id:"params",depth:4},{text:"`request`",id:"request",depth:4},{text:"Return Value",id:"return-value",depth:4},{text:"Request API",id:"request-api",depth:3},{text:"Error Handling",id:"error-handling",depth:3},{text:"Get data from parent component",id:"get-data-from-parent-component",depth:3},{text:"(WIP)Loading UI",id:"wiploading-ui",depth:3},{text:"Data Cache",id:"data-cache",depth:3},{text:"`shouldRevalidate`",id:"shouldrevalidate",depth:3},{text:"Client Loader",id:"client-loader",depth:3},{text:"Applicable scenarios",id:"applicable-scenarios",depth:4},{text:"Incorrect usage",id:"incorrect-usage",depth:3},{text:"FAQ",id:"faq",depth:3},{text:"useLoader (old version)",id:"useloader-old-version",depth:2}],title:"Data Fetching",frontmatter:{title:"Data Fetching",sidebar_position:3}}}}]);