(self.webpackChunk_modern_js_main_doc=self.webpackChunk_modern_js_main_doc||[]).push([["docs_zh_tutorials_examples_csr-auth_mdx"],{1859:function(n,e,t){"use strict";t.r(e),t.d(e,{default:function(){return l}});var r,o=t("15169"),a=t("43932"),i=t("9880"),s=t("23169"),u=t("88617");function c(n){var e=Object.assign({h1:"h1",a:"a",p:"p",ul:"ul",li:"li",code:"code",pre:"pre"},(0,s.useMDXComponents)(),n.components);return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(e.h1,{id:"路由鉴权",children:["路由鉴权",(0,i.jsx)(e.a,{className:"header-anchor","aria-hidden":"true",href:"#路由鉴权",children:"#"})]}),"\n",(0,i.jsxs)(e.p,{children:["Modern.js 默认提供的路由方式是基于 React Router 6 的约定式路由，具体可查看",(0,i.jsx)(e.a,{href:"/guides/basic-features/routes#%E8%B7%AF%E7%94%B1%E6%96%B9%E6%A1%88",children:"路由方案"}),"。"]}),"\n",(0,i.jsx)(e.p,{children:"在一个 Web 应用中如果存在多个路由，我们可能需要对部分路由进行鉴权后才能访问。例如下面这个案例："}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:["访问 ",(0,i.jsx)(e.code,{children:"/"})," 路由，无需鉴权，可直接访问。"]}),"\n",(0,i.jsxs)(e.li,{children:["访问 ",(0,i.jsx)(e.code,{children:"/protected"})," 路由，需要鉴权，如果无，自动跳转到 ",(0,i.jsx)(e.code,{children:"/login"})," 路由，登录成功后返回 ",(0,i.jsx)(e.code,{children:"/protected"}),"。"]}),"\n"]}),"\n","\n",(0,i.jsxs)(u.default,{template:"web-app",children:[(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-tsx",meta:'title="src/routes/page.tsx"',children:'import { Helmet } from \'@modern-js/runtime/head\';\nimport \'./index.css\';\n\nconst PublicPage = (): JSX.Element => (\n  <div className="container-box">\n    <Helmet>\n      <link\n        rel="icon"\n        type="image/x-icon"\n        href="https://lf3-static.bytednsdoc.com/obj/eden-cn/uhbfnupenuhf/favicon.ico"\n      />\n    </Helmet>\n    <h3>Public</h3>\n  </div>\n);\n\nexport default PublicPage;\n\n'})}),(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-tsx",meta:'title="src/routes/layout.tsx"',children:"import { Link, Outlet } from '@modern-js/runtime/router';\nimport { AuthProvider, AuthStatus } from './Auth';\n\nexport default function Layout() {\n  return (\n    <AuthProvider>\n      <AuthStatus />\n\n      <ul>\n        <li>\n          <Link to=\"/\">Public Page</Link>\n        </li>\n        <li>\n          <Link to=\"/protected\">Protected Page</Link>\n        </li>\n      </ul>\n\n      <Outlet />\n    </AuthProvider>\n  );\n}\n\n"})}),(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-ts",meta:'title="src/routes/fakeAuth.ts"',children:"/**\n * This represents some generic auth provider API, like Firebase.\n */\nconst fakeAuthProvider = {\n  isAuthenticated: false,\n  signin(callback: VoidFunction) {\n    fakeAuthProvider.isAuthenticated = true;\n    setTimeout(callback, 100); // fake async\n  },\n  signout(callback: VoidFunction) {\n    fakeAuthProvider.isAuthenticated = false;\n    setTimeout(callback, 100);\n  },\n};\n\nexport { fakeAuthProvider };\n\n"})}),(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-ts",meta:'title="src/routes/Auth.tsx"',children:"import React from 'react';\nimport { useNavigate, Navigate, useLocation } from '@modern-js/runtime/router';\nimport { fakeAuthProvider } from './fakeAuth';\n\ninterface AuthContextType {\n  user: any;\n  signin: (user: string, callback: VoidFunction) => void;\n  signout: (callback: VoidFunction) => void;\n}\n\nconst AuthContext = React.createContext<AuthContextType>(null!);\n\nexport function AuthProvider({ children }: { children: React.ReactNode }) {\n  const [user, setUser] = React.useState<any>(null);\n\n  const signin = (newUser: string, callback: VoidFunction) =>\n    fakeAuthProvider.signin(() => {\n      setUser(newUser);\n      callback();\n    });\n\n  const signout = (callback: VoidFunction) =>\n    fakeAuthProvider.signout(() => {\n      setUser(null);\n      callback();\n    });\n\n  const value = { user, signin, signout };\n\n  return <AuthContext.Provider value={value}>{children}</AuthContext.Provider>;\n}\n\nexport function useAuth() {\n  return React.useContext(AuthContext);\n}\n\nexport function AuthStatus() {\n  const auth = useAuth();\n  console.log('auth', auth);\n  const navigate = useNavigate();\n\n  if (!auth.user) {\n    return <p>You are not logged in.</p>;\n  }\n\n  return (\n    <p>\n      Welcome {auth.user}!{' '}\n      <button\n        type=\"button\"\n        onClick={() => {\n          auth.signout(() => navigate('/'));\n        }}\n      >\n        Sign out\n      </button>\n    </p>\n  );\n}\n\nexport function RequireAuth({ children }: { children: JSX.Element }) {\n  const auth = useAuth();\n  const location = useLocation();\n\n  if (!auth.user) {\n    // Redirect them to the /login page, but save the current location they were\n    // trying to go to when they were redirected. This allows us to send them\n    // along to that page after they login, which is a nicer user experience\n    // than dropping them off on the home page.\n    return <Navigate to=\"/login\" state={{ from: location }} replace />;\n  }\n\n  return children;\n}\n\n"})}),(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-ts",meta:'title="src/routes/protected/page.tsx"',children:"import { RequireAuth } from '../Auth';\n\nexport default function ProtectedPage() {\n  return (\n    <div className=\"container-box\">\n      <RequireAuth>\n        <h3>Protected</h3>\n      </RequireAuth>\n    </div>\n  );\n}\n\n"})}),(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-ts",meta:'title="src/routes/login/page.tsx"',children:"import { useLocation, useNavigate } from '@modern-js/runtime/router';\nimport { useAuth } from '../Auth';\n\nexport default function Login() {\n  const navigate = useNavigate();\n  const location = useLocation();\n  const auth = useAuth();\n\n  const from = location.state?.from?.pathname || '/';\n\n  function handleSubmit(event: React.FormEvent<HTMLFormElement>) {\n    event.preventDefault();\n\n    const formData = new FormData(event.currentTarget);\n    const username = formData.get('username') as string;\n\n    auth.signin(username, () => {\n      // Send them back to the page they tried to visit when they were\n      // redirected to the login page. Use { replace: true } so we don't create\n      // another entry in the history stack for the login page.  This means that\n      // when they get to the protected page and click the back button, they\n      // won't end up back on the login page, which is also really nice for the\n      // user experience.\n      navigate(from, { replace: true });\n    });\n  }\n\n  return (\n    <div>\n      <p>You must log in to view the page at {from}</p>\n\n      <form onSubmit={handleSubmit}>\n        <label>\n          Username: <input name=\"username\" type=\"text\" />\n        </label>{' '}\n        <button type=\"submit\">Login</button>\n      </form>\n    </div>\n  );\n}\n\n"})})]})]})}(r=globalThis).__RSPRESS_PAGE_META||(r.__RSPRESS_PAGE_META={}),globalThis.__RSPRESS_PAGE_META["zh%2Ftutorials%2Fexamples%2Fcsr-auth.mdx"]={toc:[],title:"路由鉴权",frontmatter:{title:"路由鉴权"}};var l=function(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=Object.assign({},(0,s.useMDXComponents)(),n.components).wrapper;return e?(0,i.jsx)(e,(0,a._)((0,o._)({},n),{children:(0,i.jsx)(c,(0,o._)({},n))})):c(n)}}}]);