/*! For license information please see 22970.87657d89.js.LICENSE.txt */
(self.webpackChunk_modern_js_main_doc=self.webpackChunk_modern_js_main_doc||[]).push([["22970"],{34922:function(e,n,s){"use strict";s.r(n);var r=s("39980"),a=s("9580");function t(e){let n=Object.assign({h1:"h1",a:"a",p:"p",h2:"h2",pre:"pre",code:"code",strong:"strong",h3:"h3"},(0,a.ah)(),e.components);return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(n.h1,{id:"unstable-middleware",children:["Unstable Middleware",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#unstable-middleware",children:"#"})]}),"\n",(0,r.jsxs)(n.p,{children:["\u7528\u4E8E\u62D3\u5C55 Modern.js \u5185\u7F6E\u7684 Web Server\u3002 \u672A\u6765 UnstableMiddleware \u5C06\u66FF\u4EE3 ",(0,r.jsx)(n.a,{href:"/apis/app/runtime/web-server/middleware",children:"Middleware"})]}),"\n",(0,r.jsxs)(n.h2,{id:"\u4F7F\u7528",children:["\u4F7F\u7528",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#\u4F7F\u7528",children:"#"})]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",meta:'title="server/index.ts"',children:"import { UnstableMiddleware } from '@modern-js/runtime/server';\n\nexport const unstableMiddleware: UnstableMiddleware[] = [];\n"})}),"\n",(0,r.jsxs)(n.h2,{id:"\u7C7B\u578B",children:["\u7C7B\u578B",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#\u7C7B\u578B",children:"#"})]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"UnstableMiddleware"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"type UnstableMiddleware<\n  V extends Record<string, unknown> = Record<string, unknown>,\n> = (\n  c: UnstableMiddlewareContext<V>,\n  next: UnstableNext,\n) => Promise<void | Response>;\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"UnstableMiddlewareContext"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"type Body = ReadableStream | ArrayBuffer | string | null;\n\ntype UnstableMiddlewareContext<\n  V extends Record<string, unknown> = Record<string, unknown>,\n> = {\n  request: Request;\n  response: Response;\n  get: Get<V>;\n  set: Set<V>;\n  header: (name: string, value: string, options?: { append?: boolean }) => void;\n  status: (code: number) => void;\n  redirect: (location: string, status?: number) => Response;\n  body: (data: Body, init?: ResponseInit) => Response;\n  html: (\n    data: string | Promise<string>,\n    init?: ResponseInit,\n  ) => Response | Promise<Response>;\n};\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"UnstableNext"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"type UnstableNext = () => Promise<void>;\n"})}),"\n",(0,r.jsxs)(n.h2,{id:"\u7528\u4F8B",children:["\u7528\u4F8B",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#\u7528\u4F8B",children:"#"})]}),"\n",(0,r.jsxs)(n.h3,{id:"web-server-\u8017\u65F6\u6253\u70B9",children:["web server \u8017\u65F6\u6253\u70B9",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#web-server-\u8017\u65F6\u6253\u70B9",children:"#"})]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"import { UnstableMiddleware } from '@modern-js/runtime/server';\n\nconst time: UnstableMiddleware = async (c, next) => {\n  const start = Date.now();\n\n  await next();\n\n  const end = Date.now();\n\n  console.log(`${end - start}`);\n};\n\nexport const unstableMiddleware: UnstableMiddleware[] = [time];\n"})}),"\n",(0,r.jsxs)(n.h3,{id:"\u6CE8\u5165\u670D\u52A1\u7AEF\u6570\u636E\u4F9B\u9875\u9762-dataloader-\u6D88\u8D39",children:["\u6CE8\u5165\u670D\u52A1\u7AEF\u6570\u636E\uFF0C\u4F9B\u9875\u9762 dataLoader \u6D88\u8D39",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#\u6CE8\u5165\u670D\u52A1\u7AEF\u6570\u636E\u4F9B\u9875\u9762-dataloader-\u6D88\u8D39",children:"#"})]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",meta:'title="shared/index.ts"',children:"export type Vars = {\n  message: string;\n};\n"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",meta:'title="server/index.ts"',children:"import {\n  UnstableMiddleware,\n  UnstableMiddlewareContext,\n} from '@modern-js/runtime/server';\nimport type { Vars } from '../shared/index';\n\nconst setPayload: UnstableMiddleware = async (\n  c: UnstableMiddlewareContext<Vars>,\n  next,\n) => {\n  c.set('message', 'facker');\n\n  await next();\n};\n\nexport const unstableMiddleware: UnstableMiddleware[] = [setPayload];\n"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",meta:'title="src/routes/page.data.ts"',children:"import type { Payload } from '../../shared/index';\nimport { LoaderFunctionArgs } from '@modern-js/runtime/router';\n\nexport const loader = async ({ context }: LoaderFunctionArgs<Vars>) => {\n  const message = context?.get('message');\n\n  // ...\n};\n"})}),"\n",(0,r.jsxs)(n.h3,{id:"\u91CD\u5B9A\u5411",children:["\u91CD\u5B9A\u5411",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#\u91CD\u5B9A\u5411",children:"#"})]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"import { UnstableMiddleware } from '@modern-js/runtime/server';\n\nconst auth: UnstableMiddleware = async (c, next) => {\n  const user = getUser(c.request);\n\n  if (!user) {\n    return c.redirect('/login');\n  }\n\n  await next();\n};\n\nexport const unstableMiddleware: UnstableMiddleware[] = [auth];\n"})}),"\n",(0,r.jsxs)(n.h3,{id:"\u4FEE\u6539\u54CD\u5E94\u4F53",children:["\u4FEE\u6539\u54CD\u5E94\u4F53",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#\u4FEE\u6539\u54CD\u5E94\u4F53",children:"#"})]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"import { UnstableMiddleware } from '@modern-js/runtime/server';\n\nconst modifier: UnstableMiddleware = async (c, next) => {\n  await next();\n\n  const { response } = c;\n\n  const text = await response.text();\n\n  const newText = text.replace('<html>', `<html lang=\"${language}\">`);\n\n  const newheaders = response.headers;\n  newheaders.set('x-custom-value', 'modern');\n\n  c.response = c.body(newText, {\n    status: response.status,\n    headers: newheaders,\n  });\n};\n\nexport const unstableMiddleware: UnstableMiddleware[] = [modifier];\n"})})]})}function d(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:n}=Object.assign({},(0,a.ah)(),e.components);return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(t,{...e})}):t(e)}n.default=d,d.__RSPRESS_PAGE_META={},d.__RSPRESS_PAGE_META["zh%2Fapis%2Fapp%2Fruntime%2Fweb-server%2Funstable_middleware.mdx"]={toc:[{text:"\u4F7F\u7528",id:"\u4F7F\u7528",depth:2},{text:"\u7C7B\u578B",id:"\u7C7B\u578B",depth:2},{text:"\u7528\u4F8B",id:"\u7528\u4F8B",depth:2},{text:"web server \u8017\u65F6\u6253\u70B9",id:"web-server-\u8017\u65F6\u6253\u70B9",depth:3},{text:"\u6CE8\u5165\u670D\u52A1\u7AEF\u6570\u636E\uFF0C\u4F9B\u9875\u9762 dataLoader \u6D88\u8D39",id:"\u6CE8\u5165\u670D\u52A1\u7AEF\u6570\u636E\u4F9B\u9875\u9762-dataloader-\u6D88\u8D39",depth:3},{text:"\u91CD\u5B9A\u5411",id:"\u91CD\u5B9A\u5411",depth:3},{text:"\u4FEE\u6539\u54CD\u5E94\u4F53",id:"\u4FEE\u6539\u54CD\u5E94\u4F53",depth:3}],title:"Unstable Middleware",frontmatter:{title:"Unstable Middleware"}}}}]);