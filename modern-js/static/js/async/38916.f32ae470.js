/*! For license information please see 38916.f32ae470.js.LICENSE.txt */
(self.webpackChunk_modern_js_main_doc=self.webpackChunk_modern_js_main_doc||[]).push([["38916"],{37229:function(e,n,s){"use strict";s.r(n);var r=s("39980"),t=s("9580");function a(e){let n=Object.assign({h1:"h1",a:"a",p:"p",h2:"h2",pre:"pre",code:"code",strong:"strong",h3:"h3"},(0,t.ah)(),e.components);return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(n.h1,{id:"unstable-middleware",children:["Unstable Middleware",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#unstable-middleware",children:"#"})]}),"\n",(0,r.jsxs)(n.p,{children:["Used to extend the built-in Web Server in Modern.js.\nUnstableMiddleware will replace ",(0,r.jsx)(n.a,{href:"/apis/app/runtime/web-server/middleware",children:"Middleware"})," in the future."]}),"\n",(0,r.jsxs)(n.h2,{id:"usage",children:["Usage",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#usage",children:"#"})]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",meta:'title="server/index.ts"',children:"import { UnstableMiddleware } from '@modern-js/runtime/server';\n\nexport const unstableMiddleware: UnstableMiddleware[] = [];\n"})}),"\n",(0,r.jsxs)(n.h2,{id:"types",children:["Types",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#types",children:"#"})]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"UnstableMiddleware"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"type UnstableMiddleware<\n  V extends Record<string, unknown> = Record<string, unknown>,\n> = (\n  c: UnstableMiddlewareContext<V>,\n  next: UnstableNext,\n) => Promise<void | Response>;\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"UnstableMiddlewareContext"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"type Body = ReadableStream | ArrayBuffer | string | null;\n\ntype UnstableMiddlewareContext<\n  V extends Record<string, unknown> = Record<string, unknown>,\n> = {\n  request: Request;\n  response: Response;\n  get: Get<V>;\n  set: Set<V>;\n  header: (name: string, value: string, options?: { append?: boolean }) => void;\n  status: (code: number) => void;\n  redirect: (location: string, status?: number) => Response;\n  body: (data: Body, init?: ResponseInit) => Response;\n  html: (\n    data: string | Promise<string>,\n    init?: ResponseInit,\n  ) => Response | Promise<Response>;\n};\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"UnstableNext"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"type UnstableNext = () => Promise<void>;\n"})}),"\n",(0,r.jsxs)(n.h2,{id:"examples",children:["Examples",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#examples",children:"#"})]}),"\n",(0,r.jsxs)(n.h3,{id:"web-server-timing",children:["Web Server Timing",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#web-server-timing",children:"#"})]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"import { UnstableMiddleware } from '@modern-js/runtime/server';\n\nconst time: UnstableMiddleware = async (c, next) => {\n  const start = Date.now();\n\n  await next();\n\n  const end = Date.now();\n\n  console.log(`${end - start}`);\n};\n\nexport const unstableMiddleware: UnstableMiddleware[] = [time];\n"})}),"\n",(0,r.jsxs)(n.h3,{id:"injecting-server-data-for-dataloader-consumption",children:["Injecting Server Data for DataLoader Consumption",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#injecting-server-data-for-dataloader-consumption",children:"#"})]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",meta:'title="shared/index.ts"',children:"export type Vars = {\n  message: string;\n};\n"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",meta:'title="server/index.ts"',children:"import {\n  UnstableMiddleware,\n  UnstableMiddlewareContext,\n} from '@modern-js/runtime/server';\nimport type { Vars } from '../shared/index';\n\nconst setPayload: UnstableMiddleware = async (\n  c: UnstableMiddlewareContext<Vars>,\n  next,\n) => {\n  c.set('message', 'facker');\n\n  await next();\n};\n\nexport const unstableMiddleware: UnstableMiddleware[] = [setPayload];\n"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",meta:'title="src/routes/page.data.ts"',children:"import type { Payload } from '../../shared/index';\nimport { LoaderFunctionArgs } from '@modern-js/runtime/router';\n\nexport const loader = async ({ context }: LoaderFunctionArgs<Vars>) => {\n  const message = context?.get('message');\n\n  // ...\n};\n"})}),"\n",(0,r.jsxs)(n.h3,{id:"redirect",children:["Redirect",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#redirect",children:"#"})]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"import { UnstableMiddleware } from '@modern-js/runtime/server';\n\nconst auth: UnstableMiddleware = async (c, next) => {\n  const user = getUser(c.request);\n\n  if (!user) {\n    return c.redirect('/login');\n  }\n\n  await next();\n};\n\nexport const unstableMiddleware: UnstableMiddleware[] = [auth];\n"})}),"\n",(0,r.jsxs)(n.h3,{id:"modify-response",children:["Modify Response",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#modify-response",children:"#"})]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"import { UnstableMiddleware } from '@modern-js/runtime/server';\n\nconst modifier: UnstableMiddleware = async (c, next) => {\n  await next();\n\n  const { response } = c;\n\n  const text = await response.text();\n\n  const newText = text.replace('<html>', `<html lang=\"${language}\">`);\n\n  const newheaders = response.headers;\n  newheaders.set('x-custom-value', 'modern');\n\n  c.response = c.body(newText, {\n    status: response.status,\n    headers: newheaders,\n  });\n};\n\nexport const unstableMiddleware: UnstableMiddleware[] = [modifier];\n"})})]})}function d(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:n}=Object.assign({},(0,t.ah)(),e.components);return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(a,{...e})}):a(e)}n.default=d,d.__RSPRESS_PAGE_META={},d.__RSPRESS_PAGE_META["en%2Fapis%2Fapp%2Fruntime%2Fweb-server%2Funstable_middleware.mdx"]={toc:[{text:"Usage",id:"usage",depth:2},{text:"Types",id:"types",depth:2},{text:"Examples",id:"examples",depth:2},{text:"Web Server Timing",id:"web-server-timing",depth:3},{text:"Injecting Server Data for DataLoader Consumption",id:"injecting-server-data-for-dataloader-consumption",depth:3},{text:"Redirect",id:"redirect",depth:3},{text:"Modify Response",id:"modify-response",depth:3}],title:"Unstable Middleware",frontmatter:{title:"Unstable Middleware"}}}}]);